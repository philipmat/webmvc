<html>
	<head>
		<script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js'></script>
		<script type='text/javascript' src='knockout-2.0.0.debug.js'></script>
		<script type='text/javascript' src='underscore.js'></script>
		<script type='text/javascript'>
			function getQS(uri) {
				return uri.substr(1);
			}

			function getParts(uri) {
				var parts = getQS(uri).split('/');
				parts = _(parts).filter(function (it) { return it !== ''; });
				var ns = _.first(parts),
					id = _.first(_.rest(parts));
				return { ns : ns, id : id };
			}

			function includeHelper(ns) {
				$('head').append( $('<script/>', {
					src : ns + '/kn-helper.js',
					type : 'text/javascript'}));
			}

			function setup(uri) {
				var parts = getParts(uri);
				console.log(parts);
				var ns = parts.ns, id = parts.id;
				includeHelper(ns);
				if (ns !== undefined) {
					var all_uri = '../data/' + ns + '/all.js';
					console.log('Loading all: %s', all_uri);
					$.getJSON(all_uri, function(data) {
						window[ns].loadViewModel(data);
						console.log(window[ns].ViewModel);
						if (id !== undefined) {
							var id_uri = '../data/' + ns + '/' + id + '.js';
							$.getJSON(id_uri, function(data) {
								window[ns].loadModel(data);
								console.log(window[ns].ViewModel);
								ko.applyBindings(window[ns].ViewModel);
							});
						} else {
							ko.applyBindings(window[ns].ViewModel);
						}

					});
				}
			}

			function testBind() {
				var parts = getParts(window.location.search);
				window[parts.ns].testBind();
			}


			$(document).ready(setup(window.location.search));
		</script>
	</head>
	<body>
		<a href="index.html">Back</a>	
		<a href="javascript:testBind()">Bind</a>
		<div class="single">
			Id : <span data-bind="text: active.id"></span><br/>
			Name:<input id="name" type="text" data-bind="value: active.name"/><br/>
			Url:<input id="url" type="text" data-bind="value: active.url" /><br/>
			<input type="button" value="New" />
			<input type="submit" value="Update" />
			<input type="button" value="Delete" />
		</div>
		<div class="multi">
			<table>
				<thead>
					<tr>
						<th>id</th>
						<th>Name</th>
					</tr>
				</thead>
				<tbody data-bind="foreach: elements">
					<tr>
						<td><a data-bind="attr : { href : prepUrl }, text: id"></a></td>
						<td><a data-bind="attr: { href: url}, text: name"></a></td>
					</tr>
				</tbody>
			</table>
		</div>
	</body>
</html>

